import * as tf from "@tensorflow/tfjs";
import React, { useState, useEffect } from "react";
import { Bar } from "react-chartjs-2";
import { ToastContainer, toast } from "react-toastify";
import "react-toastify/dist/ReactToastify.css";
import {
  Chart as ChartJS,
  CategoryScale,
  LinearScale,
  BarElement,
  Title,
  Tooltip,
  Legend,
} from "chart.js";

// Register chart.js components
ChartJS.register(
  CategoryScale,
  LinearScale,
  BarElement,
  Title,
  Tooltip,
  Legend
);

const App = () => {
  const [expenses, setExpenses] = useState<
    { category: string; amount: number }[]
  >([]);
  const [category, setCategory] = useState("");
  const [amount, setAmount] = useState<number | "">(0);
  const [budget, setBudget] = useState<number | "">(0);
  const [savingsGoal, setSavingsGoal] = useState<number | "">(0);
  const [model, setModel] = useState<any>(null); // AI model to predict over-budget status
  const [prediction, setPrediction] = useState<string>("");

  const totalExpenses = expenses.reduce((acc, curr) => acc + curr.amount, 0);
  const isOverBudget = totalExpenses > budget;
  const remainingSavings = savingsGoal - (budget - totalExpenses);

  const addExpense = () => {
    if (category && amount > 0) {
      setExpenses([...expenses, { category, amount: Number(amount) }]);
      setCategory("");
      setAmount(0);
      toast.success("Expense added successfully!");
    } else {
      toast.error("Please fill out both fields correctly.");
    }
  };

  const chartData = {
    labels: expenses.map((e) => e.category),
    datasets: [
      {
        label: "Expenses",
        data: expenses.map((e) => e.amount),
        backgroundColor: [
          "#4caf50",
          "#ff9800",
          "#2196f3",
          "#f44336",
          "#9c27b0",
          "#673ab7",
          "#00bcd4",
        ],
      },
    ],
  };

  const savingsChartData = {
    labels: ["Saved", "Remaining"],
    datasets: [
      {
        data: [
          budget - totalExpenses,
          remainingSavings > 0 ? remainingSavings : 0,
        ],
        backgroundColor: ["#4caf50", "#f44336"],
      },
    ],
  };

  useEffect(() => {
    localStorage.setItem("expenses", JSON.stringify(expenses));
    localStorage.setItem("budget", JSON.stringify(budget));
    localStorage.setItem("savingsGoal", JSON.stringify(savingsGoal));
  }, [expenses, budget, savingsGoal]);

  useEffect(() => {
    const savedExpenses = JSON.parse(localStorage.getItem("expenses") || "[]");
    const savedBudget = JSON.parse(localStorage.getItem("budget") || "0");
    const savedSavingsGoal = JSON.parse(
      localStorage.getItem("savingsGoal") || "0"
    );

    setExpenses(savedExpenses);
    setBudget(savedBudget);
    setSavingsGoal(savedSavingsGoal);
  }, []);

  useEffect(() => {
    if (isOverBudget) {
      toast.warn("Alert: You are over your budget!");
    }
    if (totalExpenses > budget * 0.8) {
      toast.info("Tip: Consider cutting back on dining or subscriptions!");
    }
  }, [totalExpenses, budget]);

  useEffect(() => {
    // Load pre-trained model or train a new one if necessary
    const loadModel = async () => {
      // For simplicity, a basic regression model that predicts over-budget status
      const model = await tf.sequential();
      model.add(tf.layers.dense({ units: 1, inputShape: [1] }));
      model.compile({ loss: "meanSquaredError", optimizer: "sgd" });

      // Train the model with some dummy data (you can train with real data later)
      const trainingData = tf.tensor2d([totalExpenses], [1, 1]);
      const outputData = tf.tensor2d([isOverBudget ? 1 : 0], [1, 1]);

      await model.fit(trainingData, outputData, { epochs: 10 });
      setModel(model);
    };

    loadModel();
  }, [totalExpenses, isOverBudget]);

  useEffect(() => {
    if (model) {
      const predictBudgetStatus = async () => {
        const predictionResult = model.predict(
          tf.tensor2d([totalExpenses], [1, 1])
        );
        const result =
          predictionResult.dataSync()[0] > 0.5
            ? "Likely to exceed budget"
            : "On track";
        setPrediction(result);
      };
      predictBudgetStatus();
    }
  }, [model, totalExpenses]);

  return (
    <div style={styles.container}>
      <h1 style={styles.header}>Welcome to Swaya!</h1>

      <div style={styles.inputContainer}>
        <div style={styles.inputGroup}>
          <h4>Enter your monthly budget</h4>
          <input
            type="number"
            value={budget}
            onChange={(e) => setBudget(Number(e.target.value))}
            placeholder="Enter your monthly budget"
            style={styles.input}
          />
        </div>
        <div style={styles.inputGroup}>
          <h4>Enter your savings goal</h4>
          <input
            type="number"
            value={savingsGoal}
            onChange={(e) => setSavingsGoal(Number(e.target.value))}
            placeholder="Enter your savings goal"
            style={styles.input}
          />
        </div>
      </div>

      <div style={styles.inputContainer}>
        <h2>Expense Tracker</h2>
        <div style={styles.inputGroup}>
          <input
            type="text"
            value={category}
            onChange={(e) => setCategory(e.target.value)}
            placeholder="Category"
            style={styles.input}
          />
        </div>
        <div style={styles.inputGroup}>
          <input
            type="number"
            value={amount}
            onChange={(e) => setAmount(Number(e.target.value))}
            placeholder="Amount"
            style={styles.input}
          />
        </div>
        <div style={styles.buttonContainer}>
          <button onClick={addExpense} style={styles.button}>
            Add Expense
          </button>
        </div>
      </div>

      <div style={styles.infoContainer}>
        <p>
          {isOverBudget
            ? "You are over your budget! Try to reduce expenses."
            : "Good job! You're staying within your budget."}
        </p>
        <p>AI Prediction: {prediction}</p>
      </div>

      {savingsGoal > 0 && (
        <div style={styles.infoContainer}>
          <p>
            {remainingSavings > 0
              ? `You need to save ₹${remainingSavings} more to reach your goal.`
              : "Congratulations! You’ve met your savings goal!"}
          </p>
        </div>
      )}

      <div style={styles.chartContainer}>
        <h3>Expense Chart</h3>
        {expenses.length > 0 ? (
          <Bar data={chartData} />
        ) : (
          <p>No expenses to display yet.</p>
        )}
      </div>

      {savingsGoal > 0 && (
        <div style={styles.chartContainer}>
          <h3>Savings Progress</h3>
          <Bar data={savingsChartData} />
        </div>
      )}

      <ToastContainer />
    </div>
  );
};

const styles = {
  container: {
    padding: "20px",
    fontFamily: "'Arial', sans-serif",
    backgroundColor: "#f5f5f5",
    minHeight: "100vh",
  },
  header: {
    fontSize: "36px",
    color: "#333",
    textAlign: "center",
    marginBottom: "20px",
  },
  inputContainer: {
    marginBottom: "30px",
    display: "flex",
    flexDirection: "column",
    alignItems: "center",
  },
  inputGroup: {
    marginBottom: "15px",
    width: "100%",
    maxWidth: "400px",
  },
  input: {
    width: "100%",
    padding: "10px",
    fontSize: "16px",
    border: "1px solid #ccc",
    borderRadius: "5px",
  },
  buttonContainer: {
    marginTop: "20px",
    display: "flex",
    justifyContent: "center",
  },
  button: {
    padding: "10px 20px",
    backgroundColor: "#4caf50",
    color: "#fff",
    fontSize: "16px",
    border: "none",
    borderRadius: "5px",
    cursor: "pointer",
    transition: "background-color 0.3s ease",
  },
  buttonHover: {
    backgroundColor: "#45a049",
  },
  infoContainer: {
    marginTop: "20px",
    textAlign: "center",
    fontSize: "18px",
  },
  chartContainer: {
    marginTop: "30px",
    display: "flex",
    flexDirection: "column",
    alignItems: "center",
  },
};

export default App;
